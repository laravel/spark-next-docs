<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cookbook | Laravel Spark</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,800,800i,900,900i" rel="stylesheet" type="text/css">
    <link rel="apple-touch-icon" sizes="180x180" href="/docs/assets/img/apple-touch-icon.png?v=00aYpBgAp5">
    <link rel="icon" type="image/png" sizes="32x32" href="/docs/assets/img/favicon-32x32.png?v=00aYpBgAp5">
    <link rel="icon" type="image/png" sizes="16x16" href="/docs/assets/img/favicon-16x16.png?v=00aYpBgAp5">
    <link rel="shortcut icon" href="/docs/assets/img/favicon.ico?v=00aYpBgAp5">
    <meta name="description" content="A perfect starting point for your next great idea.">
    <meta name="docsearch:version" content="2.x.x">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/docs/assets/css/0.styles.c0c886bb.css" as="style"><link rel="preload" href="/docs/assets/js/app.05ee7705.js" as="script"><link rel="preload" href="/docs/assets/js/2.e25629a7.js" as="script"><link rel="preload" href="/docs/assets/js/43.e950f58a.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.abc10df8.js"><link rel="prefetch" href="/docs/assets/js/11.292948d0.js"><link rel="prefetch" href="/docs/assets/js/12.fba0364f.js"><link rel="prefetch" href="/docs/assets/js/13.0129f984.js"><link rel="prefetch" href="/docs/assets/js/14.c249f3c7.js"><link rel="prefetch" href="/docs/assets/js/15.be446089.js"><link rel="prefetch" href="/docs/assets/js/16.10ef0c2b.js"><link rel="prefetch" href="/docs/assets/js/17.06746c7f.js"><link rel="prefetch" href="/docs/assets/js/18.3cbf5b66.js"><link rel="prefetch" href="/docs/assets/js/19.270a8496.js"><link rel="prefetch" href="/docs/assets/js/20.60dbd01c.js"><link rel="prefetch" href="/docs/assets/js/21.4bd05637.js"><link rel="prefetch" href="/docs/assets/js/22.1f45bc2a.js"><link rel="prefetch" href="/docs/assets/js/23.06762b4f.js"><link rel="prefetch" href="/docs/assets/js/24.a4bca2a7.js"><link rel="prefetch" href="/docs/assets/js/25.4f555a75.js"><link rel="prefetch" href="/docs/assets/js/26.903b164f.js"><link rel="prefetch" href="/docs/assets/js/27.532c75a3.js"><link rel="prefetch" href="/docs/assets/js/28.d97c5e89.js"><link rel="prefetch" href="/docs/assets/js/29.1cb997ca.js"><link rel="prefetch" href="/docs/assets/js/3.dc71ae3d.js"><link rel="prefetch" href="/docs/assets/js/30.31d66a2b.js"><link rel="prefetch" href="/docs/assets/js/31.a240501c.js"><link rel="prefetch" href="/docs/assets/js/32.89d705d5.js"><link rel="prefetch" href="/docs/assets/js/33.f9d561f1.js"><link rel="prefetch" href="/docs/assets/js/34.ad941e40.js"><link rel="prefetch" href="/docs/assets/js/35.a8d7ec98.js"><link rel="prefetch" href="/docs/assets/js/36.a14c3334.js"><link rel="prefetch" href="/docs/assets/js/37.caa86f90.js"><link rel="prefetch" href="/docs/assets/js/38.7b295400.js"><link rel="prefetch" href="/docs/assets/js/39.cf57a51d.js"><link rel="prefetch" href="/docs/assets/js/4.5f6bfe57.js"><link rel="prefetch" href="/docs/assets/js/40.0b9ed858.js"><link rel="prefetch" href="/docs/assets/js/41.f6cd3bbc.js"><link rel="prefetch" href="/docs/assets/js/42.49fd1dda.js"><link rel="prefetch" href="/docs/assets/js/44.334692f8.js"><link rel="prefetch" href="/docs/assets/js/45.fd984c7c.js"><link rel="prefetch" href="/docs/assets/js/46.9932910c.js"><link rel="prefetch" href="/docs/assets/js/47.3fca8ace.js"><link rel="prefetch" href="/docs/assets/js/48.6be8820a.js"><link rel="prefetch" href="/docs/assets/js/49.ea32324b.js"><link rel="prefetch" href="/docs/assets/js/5.9e9fc063.js"><link rel="prefetch" href="/docs/assets/js/50.94f06216.js"><link rel="prefetch" href="/docs/assets/js/51.b4548d26.js"><link rel="prefetch" href="/docs/assets/js/6.6e39d20d.js"><link rel="prefetch" href="/docs/assets/js/7.f0182c65.js"><link rel="prefetch" href="/docs/assets/js/8.816df8a1.js"><link rel="prefetch" href="/docs/assets/js/9.1a2d3388.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.c0c886bb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/assets/img/logo.svg" alt="Laravel Spark" class="logo"> <span class="site-name can-hide">Laravel Spark</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://spark.laravel.com" target="_self" class="nav-link external">
  Home
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Version" class="dropdown-title"><span class="title">Version</span> <span class="arrow down"></span></button> <button type="button" aria-label="Version" class="mobile-dropdown-title"><span class="title">Version</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/1.x/" class="nav-link">
  1.x
</a></li><li class="dropdown-item"><!----> <a href="/docs/2.x/" class="nav-link router-link-active">
  2.x
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://spark.laravel.com" target="_self" class="nav-link external">
  Home
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Version" class="dropdown-title"><span class="title">Version</span> <span class="arrow down"></span></button> <button type="button" aria-label="Version" class="mobile-dropdown-title"><span class="title">Version</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/1.x/" class="nav-link">
  1.x
</a></li><li class="dropdown-item"><!----> <a href="/docs/2.x/" class="nav-link router-link-active">
  2.x
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Getting Started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/2.x/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/docs/2.x/installation.html" class="sidebar-link">Installation</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spark Paddle</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/2.x/spark-paddle/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/docs/2.x/spark-paddle/plans.html" class="sidebar-link">Plans</a></li><li><a href="/docs/2.x/spark-paddle/middleware.html" class="sidebar-link">Middleware</a></li><li><a href="/docs/2.x/spark-paddle/events.html" class="sidebar-link">Events</a></li><li><a href="/docs/2.x/spark-paddle/testing.html" class="sidebar-link">Testing</a></li><li><a href="/docs/2.x/spark-paddle/cookbook.html" class="sidebar-link">Cookbook</a></li><li><a href="/docs/2.x/spark-paddle/customization.html" class="sidebar-link">Customization</a></li><li><a href="/docs/2.x/spark-paddle/upgrade.html" class="sidebar-link">Upgrade</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Spark Stripe</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/2.x/spark-stripe/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/docs/2.x/spark-stripe/plans.html" class="sidebar-link">Plans</a></li><li><a href="/docs/2.x/spark-stripe/middleware.html" class="sidebar-link">Middleware</a></li><li><a href="/docs/2.x/spark-stripe/taxes.html" class="sidebar-link">Taxes</a></li><li><a href="/docs/2.x/spark-stripe/events.html" class="sidebar-link">Events</a></li><li><a href="/docs/2.x/spark-stripe/testing.html" class="sidebar-link">Testing</a></li><li><a href="/docs/2.x/spark-stripe/cookbook.html" aria-current="page" class="active sidebar-link">Cookbook</a></li><li><a href="/docs/2.x/spark-stripe/customization.html" class="sidebar-link">Customization</a></li><li><a href="/docs/2.x/spark-stripe/upgrade.html" class="sidebar-link">Upgrade</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cookbook"><a href="#cookbook" class="header-anchor">#</a> Cookbook</h1> <p></p><div class="table-of-contents"><ul><li><a href="#team-billing">Team Billing</a></li></ul></div><p></p> <h2 id="team-billing"><a href="#team-billing" class="header-anchor">#</a> Team Billing</h2> <p>Spark ships with &quot;user&quot; based billing by default. If your applications bills teams or a different model instead, you will need to adjust your Spark installation accordingly. We'll walk through these adjustments in the following documentation using a team billing implementation as an example.</p> <p>To make the <code>App\Models\Team</code> model our billable model, we first need to adjust Spark's default migrations. So, let's configure Spark to ignore its own default migrations and export the migrations to our application so that we can adjust them:</p> <h4 id="customizing-the-migrations"><a href="#customizing-the-migrations" class="header-anchor">#</a> Customizing The Migrations</h4> <p>To instruct Spark to ignore its migrations, call the <code>Spark::ignoreMigrations()</code> method in the <code>register</code> method of your application's <code>App\Providers\SparkServiceProvider</code> class:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Spark<span class="token punctuation">\</span>Spark</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name static-context">Spark</span><span class="token operator">::</span><span class="token function">ignoreMigrations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Next, execute the following Artisan command to publish the migrations:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>php artisan vendor:publish --tag<span class="token operator">=</span>spark-migrations
</code></pre></div><p>Now that the migrations are published in the <code>/database/migrations</code> directory, we need to change the name of the <code>2019_05_03_000001_add_spark_columns_to_users_table.php</code> file to <code>2020_05_03_000001_add_spark_columns_to_teams_table.php</code>. Adjusting the &quot;year&quot; of the migration will ensure the migration is run after the <code>teams</code> table is created in the database.</p> <p>After renaming the migration, you may update its contents such that it updates the table definition of the <code>teams</code> table instead of the <code>users</code> table. Also, update the first column so that it is added after a field on the <code>teams</code> table instead of <code>remember_token</code>.</p> <p>Next, update the <code>subscriptions</code> table migration to contain <code>team_id</code>instead of <code>user_id</code>. You should also ensure that you update the column in the migration's index as well.</p> <p>Finally, you also need to update the migration of the <code>receipts</code> table to use the <code>team_id</code> column instead of <code>user_id</code>.</p> <h4 id="updating-the-service-provider"><a href="#updating-the-service-provider" class="header-anchor">#</a> Updating The Service Provider</h4> <p>Now that the migrations have been updated, we should update the <code>SparkServiceProvider</code> to reference the <code>Team</code> model instead of the <code>User</code> model:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Team</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Spark<span class="token punctuation">\</span>Spark</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">SparkServiceProvider</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceProvider</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * Bootstrap any application services.
     *
     * @return void
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Resolve the current team...</span>
        <span class="token class-name static-context">Spark</span><span class="token operator">::</span><span class="token function">billable</span><span class="token punctuation">(</span><span class="token class-name static-context">Team</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">currentTeam</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Verify that the current user owns the team...</span>
        <span class="token class-name static-context">Spark</span><span class="token operator">::</span><span class="token function">billable</span><span class="token punctuation">(</span><span class="token class-name static-context">Team</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">authorize</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">Team</span> <span class="token variable">$billable</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                   <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">id</span> <span class="token operator">==</span> <span class="token variable">$billable</span><span class="token operator">-&gt;</span><span class="token property">user_id</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name static-context">Spark</span><span class="token operator">::</span><span class="token function">billable</span><span class="token punctuation">(</span><span class="token class-name static-context">Team</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">checkPlanEligibility</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">Team</span> <span class="token variable">$billable</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Plan</span> <span class="token variable">$plan</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="environment-variables"><a href="#environment-variables" class="header-anchor">#</a> Environment Variables</h4> <p>Next, update the <code>CASHIER_MODEL</code> environment variable to use the <code>Team</code> model instead of the <code>User</code> model:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">CASHIER_MODEL</span><span class="token operator">=</span>App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Team
</code></pre></div><h4 id="updating-the-model"><a href="#updating-the-model" class="header-anchor">#</a> Updating The Model</h4> <p>Now we can update the <code>Team</code> model to use the <code>Spark\Billable</code> trait and implement a <code>stripeEmail</code> method that returns the team owner's email address to be displayed in the Stripe dashboard as the customer identifier:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Spark<span class="token punctuation">\</span>Billable</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Team</span> <span class="token keyword">extends</span> <span class="token class-name">JetstreamTeam</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">Billable</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">stripeEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">owner</span><span class="token operator">-&gt;</span><span class="token property">email</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="spark-configuration-file"><a href="#spark-configuration-file" class="header-anchor">#</a> Spark Configuration File</h4> <p>Finally, update your application's <code>config/spark.php</code> configuration file so that it defines a <code>team</code> billable model:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Team</span><span class="token punctuation">;</span>

<span class="token string single-quoted-string">'billables'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'team'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'model'</span> <span class="token operator">=&gt;</span> <span class="token class-name static-context">Team</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>

        <span class="token string single-quoted-string">'plans'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/2.x/spark-stripe/testing.html" class="prev">
        Testing
      </a></span> <span class="next"><a href="/docs/2.x/spark-stripe/customization.html">
        Customization
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.05ee7705.js" defer></script><script src="/docs/assets/js/2.e25629a7.js" defer></script><script src="/docs/assets/js/43.e950f58a.js" defer></script>
  </body>
</html>
